services:
  # Neo4j Graph Database
  neo4j:
    image: neo4j:5.15.0
    container_name: doctags-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*,gds.*
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_dbms_memory_heap_initial__size=512M
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
      # Vector search configuration
      - NEO4J_db_tx__log_rotation_retention__policy=1G size
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - doctags-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 90s
    restart: unless-stopped

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:v1.17.0
    container_name: doctags-qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      # Storage configuration
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      # Performance tuning
      - QDRANT__SERVICE__MAX_REQUEST_SIZE_MB=32
      - QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS=0  # Auto-detect
      - QDRANT__STORAGE__OPTIMIZERS__MEMMAP_THRESHOLD_KB=50000
      # Logging
      - QDRANT__LOG_LEVEL=INFO
    volumes:
      - qdrant_storage:/qdrant/storage
      - qdrant_snapshots:/qdrant/snapshots
    networks:
      - doctags-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "bash -lc \"exec 3<>/dev/tcp/127.0.0.1/6333 && printf 'GET /readyz HTTP/1.1\\r\\nHost: 127.0.0.1\\r\\nConnection: close\\r\\n\\r\\n' >&3 && timeout 5 cat <&3 | head -n 1 | grep -q '200'\"",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  app:
    build:
      context: ./doctags_rag
      dockerfile: Dockerfile
    container_name: doctags-app
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - ./doctags_rag/.env
    environment:
      NEO4J__URI: bolt://neo4j:7687
      NEO4J__USERNAME: ${NEO4J_USERNAME:-neo4j}
      NEO4J__PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      QDRANT__HOST: qdrant
      QDRANT__PORT: 6333
      ENVIRONMENT: docker
      PATHS__MODELS_DIR: /app/models
      SECURITY__REQUIRE_ACCESS_TOKEN: ${SECURITY__REQUIRE_ACCESS_TOKEN:-${SECURITY_REQUIRE_ACCESS_TOKEN:-true}}
      SECURITY__ACCESS_TOKEN: ${SECURITY__ACCESS_TOKEN:-${SECURITY_ACCESS_TOKEN:-}}
      SECURITY__AUTH_MODE: ${SECURITY__AUTH_MODE:-${SECURITY_AUTH_MODE:-jwt}}
      SECURITY__JWT_SECRET: ${SECURITY__JWT_SECRET:-${SECURITY_JWT_SECRET:-}}
      API__RATE_LIMIT_REDIS_URL: ${API__RATE_LIMIT_REDIS_URL:-${API_RATE_LIMIT_REDIS_URL:-redis://redis:6379/0}}
      API__TRUST_PROXY_HEADERS: ${API_TRUST_PROXY_HEADERS:-false}
    volumes:
      - ./doctags_rag/models:/app/models
      - ./doctags_rag/data:/app/data
      - ./doctags_rag/config:/app/config:ro
    networks:
      - doctags-network
    depends_on:
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/api/readiness', timeout=5)\" || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Optional: Redis for caching (if needed in future)
  redis:
    image: redis:8-alpine
    container_name: doctags-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - doctags-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Optional: Prometheus for monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: doctags-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - doctags-network
    depends_on:
      - neo4j
      - qdrant
    restart: unless-stopped
    profiles:
      - monitoring

  # Optional: Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: doctags-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-grafana_admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-change_this_grafana_password}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - doctags-network
    depends_on:
      - prometheus
    restart: unless-stopped
    profiles:
      - monitoring

volumes:
  # Neo4j volumes
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local

  # Qdrant volumes
  qdrant_storage:
    driver: local
  qdrant_snapshots:
    driver: local

  # Redis volume
  redis_data:
    driver: local

  # Monitoring volumes
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  doctags-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
